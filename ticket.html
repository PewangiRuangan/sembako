<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiket Sembako</title>
    <link rel="stylesheet" href="style.css?v=4">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>

<body class="dashboard-body">

    <div class="ticket-wrapper">
        <!-- LEFT: VISUAL / QR -->
        <div class="ticket-visual">
            <h2 id="status-title">TIKET</h2>
            <span id="status-badge" class="status-badge">MEMUAT...</span>

            <div id="qrcode" style="display:flex; justify-content:center; margin-top:20px;"></div>

            <p style="margin-top:30px; font-size:0.7rem; opacity:0.5; letter-spacing:1px;">
                ID: <span id="user-id">...</span>
            </p>
        </div>

        <!-- RIGHT: DETAILS -->
        <div class="ticket-details">
            <div class="ticket-header">
                <span style="font-weight:900; color:#dfe4ea; font-size:1.2rem;">SEMBAKO 2025</span>
                <div style="display:flex; gap:10px;">
                    <img src="assets/logo_combined.png" alt="Logo" style="height: 50px;">
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Nama</div>
                <div class="detail-value" id="d-name">...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">No. HP</div>
                <div class="detail-value" id="d-phone">...</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Universitas</div>
                <div class="detail-value" id="d-uni">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Tempat Lahir</div>
                <div class="detail-value" id="d-birthplace">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Tgl Lahir</div>
                <div class="detail-value" id="d-birthdate">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status</div>
                <div class="detail-value" id="d-status" style="color:var(--primary-color);">...</div>
            </div>

            <button class="logout-btn" onclick="goBack()">Kembali</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userRaw = localStorage.getItem('sembako_user');
            if (!userRaw) {
                alert("Sesi tidak valid. Harap cek kembali.");
                window.location.href = 'index.html';
                return;
            }

            const localUser = JSON.parse(userRaw);

            try {
                // Fetch full details
                const { data: user, error } = await _supabase
                    .from('users')
                    .select('*')
                    .eq('id', localUser.id)
                    .single();

                if (error || !user) {
                    console.error(error);
                    alert("Gagal memuat data tiket.");
                    return;
                }

                // Fill Data
                document.getElementById('d-name').innerText = user.full_name;
                document.getElementById('d-phone').innerText = user.phone_number;
                document.getElementById('d-status').innerText = (user.residence_type || '-').toUpperCase();
                document.getElementById('d-uni').innerText = user.university || '-';
                document.getElementById('d-birthplace').innerText = user.birth_place || '-';
                document.getElementById('d-birthdate').innerText = user.birth_date || '-';
                document.getElementById('user-id').innerText = "#" + String(user.id).padStart(6, '0');

                // Visual Status
                const badge = document.getElementById('status-badge');
                const visualTitle = document.getElementById('status-title');

                const status = (user.residence_type || '').toUpperCase();

                if (status.includes('ASRAMA')) {
                    badge.innerText = "TIDAK BERHAK";
                    badge.classList.add('error');
                    visualTitle.innerText = "DITOLAK";
                    visualTitle.style.color = "#ff4757";
                } else {
                    badge.innerText = "VERIFIED / BERHAK";
                    badge.classList.remove('error');
                    visualTitle.innerText = "ADMIT ONE";
                    visualTitle.style.color = "#ffa502";
                }

                // Generate QR
                new QRCode(document.getElementById("qrcode"), {
                    text: JSON.stringify({ user_id: user.id }),
                    width: 140,
                    height: 140,
                    colorDark: "#2f3542",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan koneksi.");
            }
        });

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>